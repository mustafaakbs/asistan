<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS AI - Mobile Fix</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* TasarÄ±m sabit kaldÄ±, sadece stabilite iÃ§in CSS'e dokunulmadÄ± */
        :root { --primary: #00f2fe; --secondary: #4facfe; --bg-dark: #0a0e17; }
        body { font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle at center, #141e30, #0a0e17); color: #e2e8f0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); padding: 2rem; border-radius: 24px; width: 90%; max-width: 500px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); margin-top: 20px; }
        h2 { margin: 0 0 20px 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        input, select { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.5); color: white; text-align: center; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-blue { background: #2563eb; } .btn-orange { background: #f59e0b; }
        .mic-btn { width: 80px; height: 80px; border-radius: 50%; border: none; background: #ef4444; color: white; font-size: 36px; cursor: pointer; margin: 0 auto; display: flex; align-items: center; justify-content: center; position: relative; z-index: 2; }
        .mic-btn.listening { background: #22c55e; }
        #status { font-style: italic; color: #64748b; font-size: 0.9rem; margin-top: 10px; }
        #chat-log { text-align: left; max-height: 200px; overflow-y: auto; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .msg { padding: 10px; margin-bottom: 5px; border-radius: 10px; font-size: 0.9rem; }
        .user { background: rgba(59, 130, 246, 0.2); text-align: right; } .ai { background: rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body>

<div class="container">
    <h2>JARVIS MOBILE</h2>
    <input type="password" id="apiKey" placeholder="Gemini API AnahtarÄ±">
    <div class="btn-group">
        <button class="action-btn btn-blue" onclick="listModels()">Modeller</button>
        <button class="action-btn btn-orange" id="voiceLoadBtn">SESÄ° AKTÄ°F ET</button>
    </div>
    <select id="voiceSelect"><option>Ses Bekleniyor...</option></select>
    <button id="micBtn" class="mic-btn"><i class="material-icons-round">mic</i></button>
    <div id="status">HazÄ±r.</div>
    <div id="chat-log"></div>
</div>

<script>
    const apiKeyInput = document.getElementById('apiKey');
    const voiceSelect = document.getElementById('voiceSelect');
    const micBtn = document.getElementById('micBtn');
    const statusText = document.getElementById('status');
    const voiceLoadBtn = document.getElementById('voiceLoadBtn');
    const synth = window.speechSynthesis;
    let voices = [];

    // --- ANDROID SES Ã‡Ã–ZÃœCÃœ ---
    function initVoices() {
        voices = synth.getVoices();
        if (voices.length === 0) return;

        voiceSelect.innerHTML = "";
        // Sadece TÃ¼rkÃ§e sesleri veya sistem varsayÄ±lanlarÄ±nÄ± al
        let trFound = false;
        voices.forEach((v) => {
            if (v.lang.includes('tr') || v.lang.includes('TR')) {
                let opt = document.createElement('option');
                opt.value = v.name;
                opt.text = "ðŸ‡¹ðŸ‡· " + v.name;
                voiceSelect.appendChild(opt);
                trFound = true;
            }
        });

        if (!trFound) {
            let opt = document.createElement('option');
            opt.value = "default";
            opt.text = "Sistem VarsayÄ±lanÄ± (TR aranÄ±yor)";
            voiceSelect.appendChild(opt);
        }
    }

    // Android'de sesleri uyandÄ±rmak iÃ§in butona basÄ±lmasÄ± ÅžART
    voiceLoadBtn.onclick = () => {
        initVoices();
        // BoÅŸ ses Ã§alma (Android ses motorunu tetikler)
        const silent = new SpeechSynthesisUtterance("merhaba");
        silent.volume = 0;
        synth.speak(silent);
        statusText.textContent = "Ses motoru Android iÃ§in uyandÄ±rÄ±ldÄ±.";
    };

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = initVoices;
    }

    function speak(text) {
        if (synth.speaking) synth.cancel();
        
        // Android'de uzun metinler bazen kesilir, metni temizleyelim
        const utterance = new SpeechSynthesisUtterance(text);
        
        // Ses SeÃ§imi
        const selectedName = voiceSelect.value;
        const targetVoice = voices.find(v => v.name === selectedName);
        
        if (targetVoice) {
            utterance.voice = targetVoice;
            utterance.lang = targetVoice.lang;
        } else {
            utterance.lang = 'tr-TR'; // Zorunlu TR
        }

        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        // Android Hata YakalayÄ±cÄ±
        utterance.onerror = (e) => {
            console.error("TTS HatasÄ±:", e);
            statusText.textContent = "Ses HatasÄ±! TarayÄ±cÄ± izni gerekebilir.";
        };

        synth.speak(utterance);
    }

    // --- GEMINI & MÄ°KROFON ---
    async function listModels() {
        const key = apiKeyInput.value.trim();
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
        const data = await res.json();
        // BasitÃ§e ilk modeli seÃ§
        statusText.textContent = "Modeller yÃ¼klendi.";
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'tr-TR';

    micBtn.onclick = () => { recognition.start(); };
    recognition.onstart = () => { micBtn.classList.add('listening'); statusText.textContent = "Dinliyorum..."; };
    recognition.onend = () => { micBtn.classList.remove('listening'); };

    recognition.onresult = async (event) => {
        const text = event.results[0][0].transcript;
        addMsg(text, "user");
        const response = await askGemini(text);
        if (response) {
            addMsg(response, "ai");
            speak(response);
        }
    };

    async function askGemini(prompt) {
        const key = apiKeyInput.value.trim();
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: "KÄ±sa cevap ver: " + prompt }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        } catch (e) { return "Hata oluÅŸtu."; }
    }

    function addMsg(text, type) {
        const div = document.createElement('div');
        div.className = "msg " + type;
        div.innerText = text;
        document.getElementById('chat-log').prepend(div);
    }
</script>
</body>
</html>
