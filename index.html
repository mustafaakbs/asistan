<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simbiot Final UI</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* Modern KaranlÄ±k Tema */
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
        }

        /* Terminal EkranÄ± */
        .terminal {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 10px;
            border-radius: 8px;
            height: 80px;
            overflow-y: auto;
            border: 1px solid #333;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }

        /* Sohbet AlanÄ± */
        .chat-box {
            flex-grow: 1;
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid #333;
        }

        .msg {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            font-size: 15px;
            line-height: 1.4;
        }

        .user {
            background-color: #005c9e; /* Mavi */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .ai {
            background-color: #333; /* Gri */
            color: #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        /* Ayarlar Paneli */
        .settings {
            background-color: #1e1e1e;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }

        /* Mikrofon Butonu */
        .mic-container {
            display: flex;
            justify-content: center;
            padding: 10px;
        }

        .mic-btn {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(145deg, #00d2ff, #3a7bd5);
            color: white;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 100, 255, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:active { transform: scale(0.95); }
        
        /* Dinleme Animasyonu */
        .mic-btn.listening {
            background: #ff4444;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        .clean-btn {
            background: transparent;
            color: #666;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="terminal" class="terminal">> Simbiot Sistem BaÅŸlatÄ±ldÄ±...<br>> BaÄŸlantÄ± bekleniyor...</div>

    <div id="chat" class="chat-box">
        <div class="msg ai">Merhaba! Ben Simbiot. Televizyonu veya ses sistemini kontrol edebilirim.</div>
    </div>

    <div class="settings">
        <input type="password" id="apiKey" placeholder="Gemini API AnahtarÄ±nÄ± Buraya YapÄ±ÅŸtÄ±r">
        <div style="display: flex; gap: 10px;">
            <select id="voiceSelect"><option>Sesler YÃ¼kleniyor...</option></select>
        </div>
    </div>

    <div class="mic-container">
        <button id="micBtn" class="mic-btn">
            <i class="material-icons-round">mic</i>
        </button>
    </div>
    
    <button class="clean-btn" onclick="document.getElementById('chat').innerHTML=''">Sohbeti Temizle</button>
</div>

<script>
    // --- 1. FIREBASE BAÄžLANTISI ---
    const firebaseConfig = {
        databaseURL: "https://asistan-489ec-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function log(msg) {
        const t = document.getElementById('terminal');
        const time = new Date().toLocaleTimeString();
        t.innerHTML = `> [${time}] ${msg}<br>` + t.innerHTML;
    }

    // --- 2. SES SENTEZLEYÄ°CÄ° (KONUÅžMA) ---
    const synth = window.speechSynthesis;
    let voices = [];

    function loadVoices() {
        voices = synth.getVoices();
        const select = document.getElementById('voiceSelect');
        select.innerHTML = voices
            .map((v, i) => `<option value="${i}">${v.lang.includes('tr') ? 'ðŸ‡¹ðŸ‡· ' : ''}${v.name}</option>`)
            .join('');
        // TÃ¼rkÃ§e sesi otomatik seÃ§meye Ã§alÄ±ÅŸ
        const trIndex = voices.findIndex(v => v.lang.includes('tr'));
        if(trIndex !== -1) select.value = trIndex;
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    } else {
        loadVoices();
    }

    function speak(text) {
        if (!text) return;
        const utterance = new SpeechSynthesisUtterance(text);
        const selectedVoiceIndex = document.getElementById('voiceSelect').value;
        if(voices[selectedVoiceIndex]) {
            utterance.voice = voices[selectedVoiceIndex];
        }
        utterance.rate = 1.0;
        synth.speak(utterance);
    }

    // --- 3. GEMINI YAPAY ZEKA ---
    async function askGemini(userText) {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey) {
            addMsg("LÃ¼tfen Ã¶nce API AnahtarÄ±nÄ± girin!", 'ai');
            return null;
        }

        // DÄ°NAMÄ°K PROMPT (En Ã–nemli KÄ±sÄ±m)
        const systemPrompt = `
        Sen Simbiot adÄ±nda akÄ±llÄ± bir ev asistanÄ±sÄ±n. KullanÄ±cÄ±nÄ±n isteÄŸini yerine getir ve Ã§ok kÄ±sa, samimi bir cevap ver.
        
        GÃ–REVÄ°N: KullanÄ±cÄ±nÄ±n cÃ¼mlesindeki SAYILARI (ses seviyesi veya kanal numarasÄ±) tespit edip doÄŸru komutu Ã¼retmek.
        Komutu cevabÄ±nÄ±n EN SONUNA kÃ¶ÅŸeli parantez iÃ§inde ekle.
        
        KOMUT FORMATLARI:
        - Sesi X birim aÃ§: [VOL_UP_X] (Ã–rn: "Sesi 10 aÃ§" -> [VOL_UP_10])
        - Sesi X birim kÄ±s: [VOL_DN_X] (Ã–rn: "Sesi 5 kÄ±s" -> [VOL_DN_5])
        - Kanal X'e git: [CH_X] (Ã–rn: "15. kanalÄ± aÃ§" -> [CH_15])
        - Kanal Ä°leri/Geri: [CH_UP], [CH_DN]
        - Sessize al: [MUTE]
        - Uygulamalar: [NETFLIX], [YOUTUBE], [WEB]
        - GÃ¼Ã§: [POWER_TV] (TV), [POWER_SB] (Soundbar)
        - Navigasyon: [HOME], [BACK], [OK]
        
        Ã–rnek KullanÄ±cÄ±: "Sesi 8 kademe yÃ¼kselt"
        Ã–rnek Cevap: "TamamdÄ±r, sesi 8 birim aÃ§Ä±yorum. [VOL_UP_8]"
        `;

        const payload = {
            contents: [
                { role: "user", parts: [{ text: systemPrompt }] },
                { role: "user", parts: [{ text: userText }] }
            ]
        };

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error(error);
            return "BaÄŸlantÄ± hatasÄ± oluÅŸtu. [ERROR]";
        }
    }

    // --- 4. MÄ°KROFON VE Ä°ÅžLEME ---
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'tr-TR';
    recognition.interimResults = false;

    const micBtn = document.getElementById('micBtn');

    micBtn.onclick = () => {
        try { recognition.start(); } catch(e) { console.log(e); }
    };

    recognition.onstart = () => {
        micBtn.classList.add('listening');
        log("Dinleniyor...");
    };

    recognition.onend = () => {
        micBtn.classList.remove('listening');
    };

    recognition.onresult = async (event) => {
        const userTranscript = event.results[0][0].transcript;
        addMsg(userTranscript, 'user');
        
        // Gemini'ye sor
        const rawResponse = await askGemini(userTranscript);
        if(!rawResponse) return;

        // --- REGEX TEMÄ°ZLÄ°K (Temiz Ses, Gizli Komut) ---
        // 1. KÃ¶ÅŸeli parantez iÃ§indeki komutu yakala: [VOL_UP_10] gibi
        const commandMatch = rawResponse.match(/\[(.*?)\]/);
        
        // 2. KonuÅŸulacak metinden komutu sil (KullanÄ±cÄ± duymasÄ±n)
        const cleanText = rawResponse.replace(/\[.*?\]/g, "").trim();

        // 3. Ekrana yaz ve KonuÅŸ
        addMsg(cleanText, 'ai');
        speak(cleanText);

        // 4. Komutu Firebase'e gÃ¶nder
        if (commandMatch) {
            const command = commandMatch[1]; // Parantez iÃ§ini al
            log(`Komut GÃ¶nderildi: ${command}`);
            db.ref('tv_komut').set(command);
        } else {
            log("Komut bulunamadÄ±, sadece sohbet edildi.");
        }
    };

    function addMsg(text, type) {
        const chat = document.getElementById('chat');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight; // Otomatik aÅŸaÄŸÄ± kaydÄ±r
    }

</script>

</body>
</html>
