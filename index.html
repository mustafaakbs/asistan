<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simbiot Kontrol Paneli</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        .container {
            width: 100%;
            max-width: 420px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        /* Üst Başlık */
        .header {
            padding: 20px;
            background: #ffffff;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 20px; color: #1a1a1a; }
        .status { font-size: 12px; color: #4CAF50; margin-top: 5px; display: block; }

        /* Sohbet Alanı */
        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f7f9fc;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .msg {
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            max-width: 80%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .user { background: #007AFF; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai { background: #ffffff; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; }

        /* Kontrol Alanı */
        .controls { padding: 20px; background: white; border-top: 1px solid #eee; }
        
        .mic-btn {
            width: 70px; height: 70px;
            background: #007AFF;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,122,255,0.3);
            display: flex;
            align-items: center; justify-content: center;
            margin: 0 auto 15px auto;
            transition: transform 0.2s;
        }
        .mic-btn:active { transform: scale(0.95); }
        .mic-btn.listening { background: #FF3B30; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255,59,48,0.4);} 70% {box-shadow: 0 0 0 15px rgba(255,59,48,0);} 100% {box-shadow: 0 0 0 0 rgba(255,59,48,0);} }

        /* Ayarlar */
        .settings-toggle {
            text-align: center; font-size: 12px; color: #888; cursor: pointer; margin-bottom: 10px;
        }
        .settings-panel {
            display: none; background: #f1f1f1; padding: 15px; border-radius: 12px; margin-bottom: 15px;
        }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 5px; }
        
        /* Manuel Butonlar */
        .manual-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .m-btn { padding: 10px; background: #eee; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .m-btn:active { background: #ddd; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Simbiot Kontrol</h1>
        <span class="status">● Sistem Çevrimiçi</span>
    </div>

    <div id="chat" class="chat-box">
        <div class="msg ai">Merhaba! Ben Simbiot. Nasıl yardımcı olabilirim?</div>
    </div>

    <div class="controls">
        <div class="settings-toggle" onclick="toggleSettings()">⚙️ API Ayarları</div>
        
        <div id="settings" class="settings-panel">
            <input type="password" id="apiKey" placeholder="Gemini API Anahtarını Yapıştır">
            <button class="m-btn" style="width:100%; background:#4CAF50; color:white;" onclick="saveKey()">Kaydet</button>
        </div>

        <button id="micBtn" class="mic-btn"><i class="material-icons-round">mic</i></button>

        <div class="manual-grid">
            <button class="m-btn" onclick="sendCmd('POWER_TV')">TV Güç</button>
            <button class="m-btn" onclick="sendCmd('MUTE')">Sessiz</button>
            <button class="m-btn" onclick="sendCmd('POWER_SB')">Soundbar</button>
            <button class="m-btn" onclick="sendCmd('VOL_DN')">Ses -</button>
            <button class="m-btn" onclick="sendCmd('OK')">OK</button>
            <button class="m-btn" onclick="sendCmd('VOL_UP')">Ses +</button>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE ---
    const firebaseConfig = { databaseURL: "https://asistan-489ec-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- AYARLAR & API KEY KAYDETME ---
    const savedKey = localStorage.getItem('geminiKey');
    if(savedKey) document.getElementById('apiKey').value = savedKey;

    function toggleSettings() {
        const s = document.getElementById('settings');
        s.style.display = s.style.display === 'block' ? 'none' : 'block';
    }

    function saveKey() {
        const key = document.getElementById('apiKey').value;
        if(key) {
            localStorage.setItem('geminiKey', key);
            alert("API Anahtarı kaydedildi!");
            toggleSettings();
        }
    }

    // --- MANUEL KOMUT ---
    function sendCmd(cmd) {
        db.ref('tv_komut').set(cmd);
        addMsg("Komut gönderildi: " + cmd, 'user');
    }

    // --- YAPAY ZEKA ---
    async function askGemini(text) {
        const key = localStorage.getItem('geminiKey');
        if(!key) { addMsg("Lütfen önce API Anahtarını ayarlardan kaydedin!", 'ai'); return; }

        const prompt = `
        Sen ev asistanısın. Kısa cevap ver.
        Aşağıdaki komutları cümle sonuna [KÖŞELİ PARANTEZ] içinde ekle.
        Sayıları algıla.
        KOMUTLAR:
        [VOL_UP], [VOL_DN] (Sayı yoksa tek, varsa [VOL_UP_10])
        [CH_UP], [CH_DN], [CH_15] (Kanal no)
        [MUTE], [POWER_TV], [POWER_SB]
        [NETFLIX], [YOUTUBE], [WEB]
        [HOME], [BACK], [OK]
        
        Kullanıcı: "${text}"
        `;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        } catch(e) { return "Hata oluştu. API anahtarını kontrol edin."; }
    }

    // --- SES İŞLEME ---
    const micBtn = document.getElementById('micBtn');
    const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    rec.lang = 'tr-TR';

    micBtn.onclick = () => rec.start();
    rec.onstart = () => micBtn.classList.add('listening');
    rec.onend = () => micBtn.classList.remove('listening');

    rec.onresult = async (e) => {
        const text = e.results[0][0].transcript;
        addMsg(text, 'user');
        
        const response = await askGemini(text);
        
        // Komutu ayıkla ve temiz metni konuş
        const cmdMatch = response.match(/\[(.*?)\]/);
        const cleanText = response.replace(/\[.*?\]/g, "").trim();
        
        addMsg(cleanText, 'ai');
        speak(cleanText);

        if(cmdMatch) {
            const cmd = cmdMatch[1];
            db.ref('tv_komut').set(cmd);
        }
    };

    function addMsg(txt, type) {
        const d = document.createElement('div');
        d.className = `msg ${type}`; d.innerText = txt;
        document.getElementById('chat').appendChild(d);
        document.getElementById('chat').scrollTop = 9999;
    }

    function speak(txt) {
        const u = new SpeechSynthesisUtterance(txt);
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>
